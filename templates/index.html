{% extends "base.html" %}

{% block content %}
<div class="scanner-section">
    <h2>üè∑Ô∏è Enter Item QR Code</h2>
    <div class="input-group">
        <input type="text" id="qrInput" placeholder="Enter QR code (e.g., SHIRT001)" />
        <button class="btn" onclick="analyzeItem()">Analyze Item</button>
    </div>
    
    <div class="sample-codes">
        <h3>Sample QR codes to try:</h3>
        <ul>
            <li><strong>SHIRT001</strong> - Cotton T-Shirt</li>
            <li><strong>JEANS001</strong> - Denim Jeans</li>
            <li><strong>SWEAT001</strong> - Cotton-Poly Hoodie</li>
            <li><strong>DRESS001</strong> - Summer Dress</li>
            <li><strong>SOCK001</strong> - Cotton Socks</li>
        </ul>
    </div>
</div>

<div id="tubeSection" class="tube-visualization" style="display: none;">
    <h3>Water Consumption Visualization</h3>
    <div class="tube">
        <div class="tube-fill" id="tubeFill"></div>
    </div>
    <div class="tube-label" id="tubeLabel">0ml / 400ml</div>
    <p><small>Scale: 0.7L (best) = 0.06ml | 4,800L (worst) = 400ml (full tube)</small></p>
</div>

<div id="results" class="results">
Welcome to Fashion Environmental Impact Analyzer!

Enter a QR code above to analyze a clothing item's environmental impact.

The analysis will show:
‚úì Item details (weight, materials)
‚úì Material composition breakdown  
‚úì Environmental impacts per material
‚úì Total calculated impact for the item
‚úì Visual water consumption scale
</div>

<script>
document.getElementById('qrInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        analyzeItem();
    }
});

async function analyzeItem() {
    const qrCode = document.getElementById('qrInput').value.trim();
    const resultsDiv = document.getElementById('results');
    const tubeSection = document.getElementById('tubeSection');
    
    if (!qrCode) {
        alert('Please enter a QR code');
        return;
    }
    
    resultsDiv.innerHTML = 'Analyzing item... Please wait.';
    tubeSection.style.display = 'none';
    
    try {
        const response = await fetch(`/api/analyze/${qrCode}`);
        const data = await response.json();
        
        if (data.error) {
            displayError(data.message, data.available_items);
        } else {
            displayResults(data);
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
    }
}

function displayError(message, availableItems) {
    const resultsDiv = document.getElementById('results');
    let html = `<div class="error">‚ùå ${message}</div>`;
    
    if (availableItems && availableItems.length > 0) {
        html += `
        <div style="margin-top: 20px;">
            <h3>Available QR codes:</h3>
            <ul>`;
        
        availableItems.forEach(item => {
            html += `<li><strong>${item.qr_code}</strong> - ${item.item_name}</li>`;
        });
        
        html += `</ul></div>`;
    }
    
    resultsDiv.innerHTML = html;
}

function displayResults(data) {
    const resultsDiv = document.getElementById('results');
    const tubeSection = document.getElementById('tubeSection');
    const tubeFill = document.getElementById('tubeFill');
    const tubeLabel = document.getElementById('tubeLabel');
    
    let html = `
üè∑Ô∏è ITEM ANALYSIS: ${data.item.item_name}
${'='.repeat(50)}

üìã ITEM DETAILS:
QR Code: ${data.item.qr_code}
Name: ${data.item.item_name}
Brand: ${data.item.brand || 'N/A'}
Category: ${data.item.category || 'N/A'}
Weight: ${data.item.weight_grams}g

üßµ MATERIAL COMPOSITION:`;

    data.materials.forEach(material => {
        html += `\n‚Ä¢ ${material.material_name.charAt(0).toUpperCase() + material.material_name.slice(1)}: ${material.percentage}%`;
    });

    html += `\n\nüåç ENVIRONMENTAL IMPACT ANALYSIS:\n${'-'.repeat(50)}`;

    const categoryOrder = ['water_usage', 'carbon_footprint', 'energy_usage'];
    const categoryEmojis = {
        'water_usage': 'üíß',
        'carbon_footprint': 'üè≠', 
        'energy_usage': '‚ö°'
    };

    categoryOrder.forEach(category => {
        if (data.impacts[category]) {
            const impact = data.impacts[category];
            html += `\n\n${categoryEmojis[category]} ${impact.name.split(' ').slice(1).join(' ')}:`;
            
            impact.materials.forEach(mat => {
                html += `\n  ${mat.material}: ${mat.impact.toFixed(2)} ${impact.unit} for this ${data.item.weight_grams}g item`;
                html += `\n    (calculation: ${mat.percentage}% √ó ${mat.base_impact} ${mat.unit.replace('/kg', '/kg')} √ó ${(data.item.weight_grams/1000).toFixed(3)}kg)`;
            });
            
            html += `\n  TOTAL: ${impact.value.toFixed(2)} ${impact.unit}`;
        }
    });

    html += `\n\n${'='.repeat(50)}`;
    html += `\nüìä TOTAL IMPACT FOR THIS ${data.item.weight_grams}g ITEM:`;
    
    categoryOrder.forEach(category => {
        if (data.impacts[category]) {
            const impact = data.impacts[category];
            const name = impact.name.split(' ').slice(1).join(' ');
            html += `\n${name}: ${impact.value.toFixed(2)} ${impact.unit}`;
        }
    });

    resultsDiv.innerHTML = html;
    
    // Update tube visualization
    if (data.tube_scale !== undefined) {
        const percentage = Math.min((data.tube_scale / 400) * 100, 100);
        tubeFill.style.height = `${percentage}%`;
        tubeLabel.textContent = `${data.tube_scale}ml / 400ml`;
        tubeSection.style.display = 'block';
    }
}
</script>
{% endblock %}