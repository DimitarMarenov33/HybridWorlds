{% extends "base.html" %}

{% block content %}
<style>
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 30px;
        text-align: center;
        margin: -20px -20px 20px -20px;
    }

    .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .tabs {
        display: flex;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        margin: 0 -20px 20px -20px;
    }

    .tab {
        padding: 15px 25px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 16px;
        font-weight: 500;
        color: #6c757d;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .tab:hover {
        background: #e9ecef;
        color: #495057;
    }

    .tab.active {
        color: #3498db;
        border-bottom-color: #3498db;
        background: white;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: #3498db;
        color: white;
    }

    .btn-primary:hover {
        background: #2980b9;
        transform: translateY(-2px);
    }

    .btn-success {
        background: #27ae60;
        color: white;
    }

    .btn-success:hover {
        background: #219a52;
        transform: translateY(-2px);
    }

    .btn-warning {
        background: #f39c12;
        color: white;
    }

    .btn-warning:hover {
        background: #e67e22;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
    }

    .btn-danger:hover {
        background: #c0392b;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #95a5a6;
        color: white;
    }

    .btn-secondary:hover {
        background: #7f8c8d;
        transform: translateY(-2px);
    }

    .table-container {
        background: white;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        background: #f8f9fa;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
    }

    td {
        padding: 12px;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: middle;
    }

    tr:hover {
        background: #f8f9fa;
    }

    tr.selected {
        background: #e3f2fd;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-size: 18px;
    }

    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #f5c6cb;
    }

    .success {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border: 1px solid #c3e6cb;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }

    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideIn 0.3s ease;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-header h3 {
        margin: 0;
        color: #2c3e50;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .close-btn:hover {
        background: #f8f9fa;
        color: #495057;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .material-composition {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .material-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .material-row select {
        flex: 2;
    }

    .material-row input {
        flex: 1;
    }

    .material-row button {
        flex: 0 0 auto;
    }

    .percentage-total {
        font-weight: 600;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        margin-top: 10px;
    }

    .percentage-valid {
        background: #d4edda;
        color: #155724;
    }

    .percentage-invalid {
        background: #f8d7da;
        color: #721c24;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin: 2px;
        display: inline-block;
    }

    .badge-primary {
        background: #e3f2fd;
        color: #1976d2;
    }

    .badge-success {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .badge-secondary {
        background: #f5f5f5;
        color: #6c757d;
    }

    .search-box {
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        font-size: 14px;
        width: 300px;
    }

    .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        min-width: 150px;
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
    }
</style>

<div class="container">
    <div class="header">
        <h1>üóÉÔ∏è Database Management</h1>
        <p>Manage clothing items, materials, and environmental impact data</p>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('items')">
            üè∑Ô∏è Clothing Items
        </button>
        <button class="tab" onclick="switchTab('materials')">
            üßµ Materials
        </button>
        <button class="tab" onclick="switchTab('impacts')">
            üåç Environmental Impacts
        </button>
    </div>

    <!-- Clothing Items Tab -->
    <div id="items-tab" class="tab-content active">
        <div class="stats" id="items-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-items">-</div>
                <div class="stat-label">Total Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-brands">-</div>
                <div class="stat-label">Brands</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-weight">-</div>
                <div class="stat-label">Avg Weight (g)</div>
            </div>
        </div>

        <div class="controls">
            <div>
                <button class="btn btn-success" onclick="openAddItemModal()">
                    ‚ûï Add Item
                </button>
                <button class="btn btn-warning" onclick="editSelectedItem()">
                    ‚úèÔ∏è Edit Selected
                </button>
                <button class="btn btn-danger" onclick="deleteSelectedItem()">
                    üóëÔ∏è Delete Selected
                </button>
            </div>
            <div>
                <input type="text" class="search-box" placeholder="Search items..." 
                       onkeyup="filterTable('items-table', this.value)">
                <button class="btn btn-secondary" onclick="loadClothingItems()">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="items-table">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>QR Code</th>
                        <th>Name</th>
                        <th>Brand</th>
                        <th>Category</th>
                        <th>Type & Weight</th>
                        <th>Materials</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody id="items-tbody">
                    <tr>
                        <td colspan="8" class="loading">Click "Refresh" to load items</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Materials Tab -->
    <div id="materials-tab" class="tab-content">
        <div class="stats" id="materials-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-materials">-</div>
                <div class="stat-label">Total Materials</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="materials-with-data">-</div>
                <div class="stat-label">With Impact Data</div>
            </div>
        </div>

        <div class="controls">
            <div>
                <button class="btn btn-success" onclick="openAddMaterialModal()">
                    ‚ûï Add Material
                </button>
                <button class="btn btn-warning" onclick="editSelectedMaterial()">
                    ‚úèÔ∏è Edit Selected
                </button>
                <button class="btn btn-danger" onclick="deleteSelectedMaterial()">
                    üóëÔ∏è Delete Selected
                </button>
            </div>
            <div>
                <input type="text" class="search-box" placeholder="Search materials..." 
                       onkeyup="filterTable('materials-table', this.value)">
                <button class="btn btn-secondary" onclick="loadMaterials()">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="materials-table">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Density (g/cm¬≥)</th>
                        <th>Description</th>
                        <th>Impact Records</th>
                    </tr>
                </thead>
                <tbody id="materials-tbody">
                    <tr>
                        <td colspan="6" class="loading">Click "Refresh" to load materials</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Environmental Impacts Tab -->
    <div id="impacts-tab" class="tab-content">
        <div class="stats" id="impacts-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-impacts">-</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="impact-categories">-</div>
                <div class="stat-label">Categories</div>
            </div>
        </div>

        <div class="controls">
            <div>
                <button class="btn btn-success" onclick="openAddImpactModal()">
                    ‚ûï Add Impact
                </button>
                <button class="btn btn-warning" onclick="editSelectedImpact()">
                    ‚úèÔ∏è Edit Selected
                </button>
                <button class="btn btn-danger" onclick="deleteSelectedImpact()">
                    üóëÔ∏è Delete Selected
                </button>
            </div>
            <div>
                <input type="text" class="search-box" placeholder="Search impacts..." 
                       onkeyup="filterTable('impacts-table', this.value)">
                <button class="btn btn-secondary" onclick="loadImpacts()">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="impacts-table">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>ID</th>
                        <th>Material</th>
                        <th>Category</th>
                        <th>Value</th>
                        <th>Unit</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="impacts-tbody">
                    <tr>
                        <td colspan="7" class="loading">Click "Refresh" to load impacts</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div id="item-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="item-modal-title">Add Clothing Item</h3>
            <button class="close-btn" onclick="closeModal('item-modal')">&times;</button>
        </div>
        <form id="item-form">
            <div class="form-group">
                <label for="item-qr-code">QR Code *</label>
                <input type="text" id="item-qr-code" required>
            </div>
            <div class="form-group">
                <label for="item-name">Name *</label>
                <input type="text" id="item-name" required>
            </div>
            <div class="form-group">
                <label for="item-brand">Brand</label>
                <input type="text" id="item-brand">
            </div>
            <div class="form-group">
                <label for="item-category">Category</label>
                <input type="text" id="item-category">
            </div>
            <div class="form-group">
                <label for="item-weight">Weight (grams) *</label>
                <input type="number" id="item-weight" required min="1">
            </div>
            
            <div class="material-composition">
                <h4>Material Composition</h4>
                <div id="material-rows">
                    <!-- Material rows will be added dynamically -->
                </div>
                <button type="button" class="btn btn-primary" onclick="addMaterialRow()">
                    ‚ûï Add Material
                </button>
                <div id="percentage-total" class="percentage-total percentage-invalid">
                    Total: 0%
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('item-modal')">
                    Cancel
                </button>
                <button type="submit" class="btn btn-success">
                    Save Item
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Material Modal -->
<div id="material-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="material-modal-title">Add Material</h3>
            <button class="close-btn" onclick="closeModal('material-modal')">&times;</button>
        </div>
        <form id="material-form">
            <div class="form-group">
                <label for="material-name">Material Name *</label>
                <input type="text" id="material-name" required>
            </div>
            <div class="form-group">
                <label for="material-density">Density (g/cm¬≥)</label>
                <input type="number" id="material-density" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="material-description">Description</label>
                <textarea id="material-description" rows="4"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('material-modal')">
                    Cancel
                </button>
                <button type="submit" class="btn btn-success">
                    Save Material
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Impact Modal -->
<div id="impact-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="impact-modal-title">Add Environmental Impact</h3>
            <button class="close-btn" onclick="closeModal('impact-modal')">&times;</button>
        </div>
        <form id="impact-form">
            <div class="form-group">
                <label for="impact-material">Material *</label>
                <select id="impact-material" required>
                    <option value="">Select material...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="impact-category">Impact Category *</label>
                <select id="impact-category" required>
                    <option value="">Select category...</option>
                    <option value="water_usage">Water Usage</option>
                    <option value="carbon_footprint">Carbon Footprint</option>
                    <option value="energy_usage">Energy Usage</option>
                    <option value="chemical_usage">Chemical Usage</option>
                    <option value="land_use">Land Use</option>
                </select>
            </div>
            <div class="form-group">
                <label for="impact-value">Impact Value *</label>
                <input type="number" id="impact-value" required step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="impact-unit">Unit *</label>
                <select id="impact-unit" required>
                    <option value="">Select unit...</option>
                    <option value="L/kg">L/kg (Liters per kilogram)</option>
                    <option value="kg_CO2/kg">kg_CO2/kg (CO2 kg per kg)</option>
                    <option value="MJ/kg">MJ/kg (Megajoules per kg)</option>
                    <option value="kg/kg">kg/kg (Kilograms per kg)</option>
                    <option value="m¬≤/kg">m¬≤/kg (Square meters per kg)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="impact-source">Source</label>
                <textarea id="impact-source" rows="3" placeholder="Reference or source of this data..."></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('impact-modal')">
                    Cancel
                </button>
                <button type="submit" class="btn btn-success">
                    Save Impact
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Global variables
    let currentTab = 'items';
    let selectedItems = new Set();
    let selectedMaterials = new Set();
    let selectedImpacts = new Set();
    let availableMaterials = [];
    let editingItemId = null;
    let editingMaterialId = null;
    let editingImpactId = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        loadClothingItems();
        loadMaterials();
        setupEventListeners();
    });

    function setupEventListeners() {
        // Form submissions
        document.getElementById('item-form').addEventListener('submit', handleItemSubmit);
        document.getElementById('material-form').addEventListener('submit', handleMaterialSubmit);
        document.getElementById('impact-form').addEventListener('submit', handleImpactSubmit);

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });
    }

    // Tab switching
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(tabName + '-tab').classList.add('active');

        currentTab = tabName;

        // Load data for the selected tab
        if (tabName === 'materials' && document.getElementById('materials-tbody').innerHTML.includes('Click "Refresh"')) {
            loadMaterials();
        } else if (tabName === 'impacts' && document.getElementById('impacts-tbody').innerHTML.includes('Click "Refresh"')) {
            loadImpacts();
        }
    }

    // API calls
    async function apiCall(url, options = {}) {
        try {
            const response = await fetch(url, options);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.message || 'Request failed');
            }
            
            return data;
        } catch (error) {
            console.error('API Error:', error);
            showMessage(error.message, 'error');
            throw error;
        }
    }

    // Load clothing items
    async function loadClothingItems() {
        const tbody = document.getElementById('items-tbody');
        tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading items...</td></tr>';

        try {
            const items = await apiCall('/api/items');
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No items found</td></tr>';
                updateItemsStats(items);
                return;
            }

            // Load material composition for each item
            const itemsWithMaterials = await Promise.all(items.map(async (item) => {
                try {
                    const materials = await apiCall(`/api/materials/${item.qr_code}`);
                    item.materials = materials;
                    return item;
                } catch (error) {
                    item.materials = [];
                    return item;
                }
            }));

            tbody.innerHTML = itemsWithMaterials.map(item => `
                <tr onclick="toggleRowSelection('items', '${item.qr_code}', this)">
                    <td>
                        <input type="checkbox" onchange="toggleRowSelection('items', '${item.qr_code}', this.closest('tr'))"
                               ${selectedItems.has(item.qr_code) ? 'checked' : ''}>
                    </td>
                    <td><strong>${item.qr_code}</strong></td>
                    <td>${item.item_name}</td>
                    <td>${item.brand || '-'}</td>
                    <td>${item.category || '-'}</td>
                    <td>${item.weight_grams}g</td>
                    <td>
                        ${item.materials.length > 0 
                            ? item.materials.map(m => `<span class="badge badge-primary">${m.material_name} ${m.percentage}%</span>`).join(' ')
                            : '<span class="badge badge-secondary">No materials</span>'
                        }
                    </td>
                    <td>${new Date(item.created_date).toLocaleDateString()}</td>
                </tr>
            `).join('');

            updateItemsStats(items);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="8" class="error">Error loading items: ${error.message}</td></tr>`;
        }
    }

    // Load materials
    async function loadMaterials() {
        const tbody = document.getElementById('materials-tbody');
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading materials...</td></tr>';

        try {
            const materials = await apiCall('/api/materials');
            availableMaterials = materials;
            
            if (materials.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No materials found</td></tr>';
                updateMaterialsStats(materials);
                return;
            }

            tbody.innerHTML = materials.map(material => `
                <tr onclick="toggleRowSelection('materials', '${material.material_id}', this)">
                    <td>
                        <input type="checkbox" onchange="toggleRowSelection('materials', '${material.material_id}', this.closest('tr'))"
                               ${selectedMaterials.has(material.material_id.toString()) ? 'checked' : ''}>
                    </td>
                    <td>${material.material_id}</td>
                    <td><strong>${material.material_name}</strong></td>
                    <td>${material.density_g_per_cm3 || '-'}</td>
                    <td>${material.description || '-'}</td>
                    <td>
                        <span class="badge badge-success">${material.impact_count || 0} records</span>
                    </td>
                </tr>
            `).join('');

            updateMaterialsStats(materials);
            updateMaterialSelects();
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="6" class="error">Error loading materials: ${error.message}</td></tr>`;
        }
    }

    // Load environmental impacts
    async function loadImpacts() {
        const tbody = document.getElementById('impacts-tbody');
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading impacts...</td></tr>';

        try {
            const impacts = await apiCall('/api/impacts');
            
            if (impacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No impacts found</td></tr>';
                updateImpactsStats(impacts);
                return;
            }

            tbody.innerHTML = impacts.map(impact => `
                <tr onclick="toggleRowSelection('impacts', '${impact.impact_id}', this)">
                    <td>
                        <input type="checkbox" onchange="toggleRowSelection('impacts', '${impact.impact_id}', this.closest('tr'))"
                               ${selectedImpacts.has(impact.impact_id.toString()) ? 'checked' : ''}>
                    </td>
                    <td>${impact.impact_id}</td>
                    <td><strong>${impact.material_name}</strong></td>
                    <td>
                        <span class="badge badge-primary">${impact.impact_category.replace('_', ' ')}</span>
                    </td>
                    <td>${impact.impact_value}</td>
                    <td>${impact.unit}</td>
                    <td>${impact.source || '-'}</td>
                </tr>
            `).join('');

            updateImpactsStats(impacts);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="7" class="error">Error loading impacts: ${error.message}</td></tr>`;
        }
    }

    // Row selection
    function toggleRowSelection(type, id, row) {
        const checkbox = row.querySelector('input[type="checkbox"]');
        const isChecked = checkbox.checked;
        
        if (event.target !== checkbox) {
            checkbox.checked = !isChecked;
        }
        
        const selectedSet = type === 'items' ? selectedItems : 
                            type === 'materials' ? selectedMaterials : selectedImpacts;
        
        if (checkbox.checked) {
            selectedSet.add(id);
            row.classList.add('selected');
        } else {
            selectedSet.delete(id);
            row.classList.remove('selected');
        }
    }

    // Table filtering
    function filterTable(tableId, searchTerm) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matches = text.includes(searchTerm.toLowerCase());
            row.style.display = matches ? '' : 'none';
        });
    }

    // Statistics updates
    function updateItemsStats(items) {
        document.getElementById('total-items').textContent = items.length;
        
        const brands = new Set(items.filter(item => item.brand).map(item => item.brand));
        document.getElementById('total-brands').textContent = brands.size;
        
        const avgWeight = items.length > 0 
            ? Math.round(items.reduce((sum, item) => sum + item.weight_grams, 0) / items.length)
            : 0;
        document.getElementById('avg-weight').textContent = avgWeight;
    }

    function updateMaterialsStats(materials) {
        document.getElementById('total-materials').textContent = materials.length;
        
        const withData = materials.filter(m => (m.impact_count || 0) > 0).length;
        document.getElementById('materials-with-data').textContent = withData;
    }

    function updateImpactsStats(impacts) {
        document.getElementById('total-impacts').textContent = impacts.length;
        
        const categories = new Set(impacts.map(i => i.impact_category));
        document.getElementById('impact-categories').textContent = categories.size;
    }

    // Modal management
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = '';
        
        // Reset forms
        const form = document.querySelector(`#${modalId} form`);
        if (form) form.reset();
        
        // Reset editing states
        editingItemId = null;
        editingMaterialId = null;
        editingImpactId = null;
        
        // Clear material rows
        if (modalId === 'item-modal') {
            document.getElementById('material-rows').innerHTML = '';
            updatePercentageTotal();
        }
    }

    // Item modal functions
    function openAddItemModal() {
        document.getElementById('item-modal-title').textContent = 'Add Clothing Item';
        document.getElementById('item-qr-code').readOnly = false;
        editingItemId = null;
        
        // Add initial material row
        addMaterialRow();
        openModal('item-modal');
    }

    function addMaterialRow() {
        const container = document.getElementById('material-rows');
        const row = document.createElement('div');
        row.className = 'material-row';
        
        const materialOptions = availableMaterials.map(m => 
            `<option value="${m.material_name}">${m.material_name}</option>`
        ).join('');
        
        row.innerHTML = `
            <select required>
                <option value="">Select material...</option>
                ${materialOptions}
            </select>
            <input type="number" placeholder="Percentage" min="0" max="100" step="0.1" 
                   oninput="updatePercentageTotal()" required>
            <button type="button" class="btn btn-danger" onclick="removeMaterialRow(this)">√ó</button>
        `;
        
        container.appendChild(row);
        updatePercentageTotal();
    }

    function removeMaterialRow(button) {
        button.closest('.material-row').remove();
        updatePercentageTotal();
    }

    function updatePercentageTotal() {
        const rows = document.querySelectorAll('.material-row');
        let total = 0;
        
        rows.forEach(row => {
            const input = row.querySelector('input[type="number"]');
            const value = parseFloat(input.value) || 0;
            total += value;
        });
        
        const totalElement = document.getElementById('percentage-total');
        totalElement.textContent = `Total: ${total.toFixed(1)}%`;
        
        if (Math.abs(total - 100) < 0.1) {
            totalElement.className = 'percentage-total percentage-valid';
        } else {
            totalElement.className = 'percentage-total percentage-invalid';
        }
    }

    function updateMaterialSelects() {
        const select = document.getElementById('impact-material');
        select.innerHTML = '<option value="">Select material...</option>' +
            availableMaterials.map(m => 
                `<option value="${m.material_name}">${m.material_name}</option>`
            ).join('');
    }

    // Form handlers
    async function handleItemSubmit(e) {
        e.preventDefault();
        
        const formData = {
            qr_code: document.getElementById('item-qr-code').value,
            name: document.getElementById('item-name').value,
            brand: document.getElementById('item-brand').value || null,
            category: document.getElementById('item-category').value || null,
            weight: parseInt(document.getElementById('item-weight').value),
            materials: []
        };
        
        // Collect material composition
        const materialRows = document.querySelectorAll('.material-row');
        materialRows.forEach(row => {
            const select = row.querySelector('select');
            const input = row.querySelector('input[type="number"]');
            
            if (select.value && input.value) {
                formData.materials.push({
                    material_name: select.value,
                    percentage: parseFloat(input.value)
                });
            }
        });
        
        try {
            const url = editingItemId ? `/api/items/${editingItemId}` : '/api/items';
            const method = editingItemId ? 'PUT' : 'POST';
            
            await apiCall(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            showMessage(editingItemId ? 'Item updated successfully!' : 'Item added successfully!', 'success');
            closeModal('item-modal');
            loadClothingItems();
        } catch (error) {
            // Error already shown by apiCall
        }
    }

    async function handleMaterialSubmit(e) {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('material-name').value,
            density: parseFloat(document.getElementById('material-density').value) || null,
            description: document.getElementById('material-description').value || null
        };
        
        try {
            const url = editingMaterialId ? `/api/materials/${editingMaterialId}` : '/api/materials';
            const method = editingMaterialId ? 'PUT' : 'POST';
            
            await apiCall(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            showMessage(editingMaterialId ? 'Material updated successfully!' : 'Material added successfully!', 'success');
            closeModal('material-modal');
            loadMaterials();
        } catch (error) {
            // Error already shown by apiCall
        }
    }

    async function handleImpactSubmit(e) {
        e.preventDefault();
        
        const formData = {
            material_name: document.getElementById('impact-material').value,
            impact_category: document.getElementById('impact-category').value,
            impact_value: parseFloat(document.getElementById('impact-value').value),
            unit: document.getElementById('impact-unit').value,
            source: document.getElementById('impact-source').value || null
        };
        
        try {
            const url = editingImpactId ? `/api/impacts/${editingImpactId}` : '/api/impacts';
            const method = editingImpactId ? 'PUT' : 'POST';
            
            await apiCall(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            showMessage(editingImpactId ? 'Impact updated successfully!' : 'Impact added successfully!', 'success');
            closeModal('impact-modal');
            loadImpacts();
        } catch (error) {
            // Error already shown by apiCall
        }
    }

    // Edit functions (simplified - will show message for now)
    function editSelectedItem() {
        if (selectedItems.size !== 1) {
            showMessage('Please select exactly one item to edit', 'error');
            return;
        }
        showMessage('Edit functionality: Select an item and use this to modify it', 'error');
    }

    function editSelectedMaterial() {
        if (selectedMaterials.size !== 1) {
            showMessage('Please select exactly one material to edit', 'error');
            return;
        }
        showMessage('Edit functionality: Select a material and use this to modify it', 'error');
    }

    function editSelectedImpact() {
        if (selectedImpacts.size !== 1) {
            showMessage('Please select exactly one impact to edit', 'error');
            return;
        }
        showMessage('Edit functionality: Select an impact and use this to modify it', 'error');
    }

    // Delete functions
    async function deleteSelectedItem() {
        if (selectedItems.size === 0) {
            showMessage('Please select items to delete', 'error');
            return;
        }
        
        if (!confirm(`Delete ${selectedItems.size} selected item(s)?`)) {
            return;
        }
        
        try {
            for (const qrCode of selectedItems) {
                await apiCall(`/api/items/${qrCode}`, { method: 'DELETE' });
            }
            
            showMessage(`${selectedItems.size} item(s) deleted successfully!`, 'success');
            selectedItems.clear();
            loadClothingItems();
        } catch (error) {
            // Error already shown by apiCall
        }
    }

    async function deleteSelectedMaterial() {
        if (selectedMaterials.size === 0) {
            showMessage('Please select materials to delete', 'error');
            return;
        }
        
        if (!confirm(`Delete ${selectedMaterials.size} selected material(s)?`)) {
            return;
        }
        
        try {
            for (const materialId of selectedMaterials) {
                await apiCall(`/api/materials/${materialId}`, { method: 'DELETE' });
            }
            
            showMessage(`${selectedMaterials.size} material(s) deleted successfully!`, 'success');
            selectedMaterials.clear();
            loadMaterials();
        } catch (error) {
            // Error already shown by apiCall
        }
    }

    async function deleteSelectedImpact() {
        if (selectedImpacts.size === 0) {
            showMessage('Please select impacts to delete', 'error');
            return;
        }
        
        if (!confirm(`Delete ${selectedImpacts.size} selected impact(s)?`)) {
            return;
        }
        
        try {
            for (const impactId of selectedImpacts) {
                await apiCall(`/api/impacts/${impactId}`, { method: 'DELETE' });
            }
            
            showMessage(`${selectedImpacts.size} impact(s) deleted successfully!`, 'success');
            selectedImpacts.clear();
            loadImpacts();
    } catch (error) {
            // Error already shown by apiCall
        }
    }

    // Material modal functions
    function openAddMaterialModal() {
        document.getElementById('material-modal-title').textContent = 'Add Material';
        editingMaterialId = null;
        openModal('material-modal');
    }

    function openAddImpactModal() {
        document.getElementById('impact-modal-title').textContent = 'Add Environmental Impact';
        editingImpactId = null;
        openModal('impact-modal');
    }

    // Utility functions
    function showMessage(message, type) {
        // Create message element
        const messageEl = document.createElement('div');
        messageEl.className = type;
        messageEl.textContent = message;
        messageEl.style.position = 'fixed';
        messageEl.style.top = '20px';
        messageEl.style.right = '20px';
        messageEl.style.zIndex = '9999';
        messageEl.style.padding = '15px 20px';
        messageEl.style.borderRadius = '8px';
        messageEl.style.maxWidth = '400px';
        messageEl.style.animation = 'slideIn 0.3s ease';
        
        document.body.appendChild(messageEl);
        
        // Remove after 5 seconds
        setTimeout(() => {
            messageEl.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 300);
        }, 5000);
}
</script>

{% endblock %}