<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Environmental Impact Analyzer - Cart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
    <style>
        /* QR Scanner for Cart Page */
        .cart-scanner {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #28a745;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .cart-scanner.active {
            border-color: #20c997;
            background: linear-gradient(135deg, #f0fff4 0%, #d4edda 100%);
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% { border-color: #28a745; }
            50% { border-color: #20c997; }
            100% { border-color: #28a745; }
        }

        .scanner-header {
            font-size: 20px;
            font-weight: 600;
            color: #155724;
            margin-bottom: 10px;
        }

        .scanner-subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .scanner-input-group {
            display: flex;
            gap: 10px;
            max-width: 500px;
            margin: 0 auto 20px;
        }

        .scanner-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #28a745;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .scanner-input:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 0 3px rgba(32, 201, 151, 0.1);
            transform: translateY(-1px);
        }

        .scanner-input.scanning {
            background: #f0fff4;
            border-color: #28a745;
            animation: scanner-pulse 1.5s infinite;
        }

        @keyframes scanner-pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .scanner-btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .scanner-btn-primary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .scanner-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .scanner-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .scanner-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .status-ready {
            background: #d4edda;
            color: #155724;
        }

        .status-scanning {
            background: #fff3cd;
            color: #856404;
        }

        .status-success {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .item-added-animation {
            animation: itemAdded 0.6s ease;
        }

        @keyframes itemAdded {
            0% { opacity: 0; transform: translateY(-20px) scale(0.9); }
            50% { transform: translateY(-10px) scale(1.05); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-weight: 500;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .cart-section {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .scanner-input-group {
                flex-direction: column;
                max-width: 100%;
            }
            
            .scanner-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- QR Scanner Section -->
        <div class="cart-scanner" id="cart-scanner">
            <div class="scanner-header">üì± Scan More Items</div>
            <div class="scanner-subtitle">Add items to your cart by scanning QR codes</div>
            
            <div id="scanner-status" class="scanner-status status-ready">
                <span id="status-icon">‚úÖ</span>
                <span id="status-text">Ready to scan - Click in the field below</span>
            </div>
            
            <div class="scanner-input-group">
                <input 
                    type="text" 
                    id="cart-qr-input" 
                    class="scanner-input" 
                    placeholder="Click here and scan QR code..."
                    autocomplete="off"
                    spellcheck="false"
                >
                <button class="scanner-btn scanner-btn-primary" onclick="manualAddToCart()">
                    ‚ûï Add Item
                </button>
            </div>
            
            <div class="scanner-controls">
                <button class="scanner-btn" style="background: #6c757d; color: white;" onclick="focusScanner()">
                    üì± Ready to Scan
                </button>
                <button class="scanner-btn" style="background: #6c757d; color: white;" onclick="clearScanner()">
                    üóëÔ∏è Clear
                </button>
                <button class="scanner-btn" style="background: #6c757d; color: white;" onclick="testCartScan()">
                    üß™ Test Scan
                </button>
            </div>
        </div>

        <!-- Cart Section -->
        <div class="cart-section">
            <h1 class="cart-title">Your Basket (<span id="cart-count">{{ cart_items|length }}</span>)</h1>
            <div id="cart-items-container">
                {% if cart_items and cart_items|length > 0 %}
                    {% for item in cart_items %}
                    <div class="product-item mb-4" data-item-name="{{ item.name }}" data-qr-code="{{ item.qr_code }}">
                        <div class="product-details">
                            <h3 class="product-name">{{ item.name }}</h3>
                            <div>
                                <span style="font-size: 15px; color: #666;">{{ item.impact }}</span>
                            </div>
                            <br>
                            <div class="product-options">
                                {% for opt in item.options %}
                                <span class="product-option">{{ opt }}</span>
                                {% endfor %}
                            </div>
                            <div id="analysis-panel-{{ loop.index0 }}" class="analysis-panel">
                                <!-- Analysis results will be displayed here -->
                            </div>
                        </div>
                        <div class="product-actions">
                            <button class="analyze-btn" onclick="analyzeItem('{{ item.qr_code }}', {{ loop.index0 }})" style="margin-right: 8px;">Analyze Item</button>
                            <button class="action-btn" title="Remove" onclick="deleteItem('{{ item.name }}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info" id="empty-cart-message">No items in your basket yet. Scan an item above to get started!</div>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="summary-section">
                <h2 class="summary-title">Summary</h2>
                <div class="summary-row">
                    <span><span id="sidebar-count">{{ cart_items|length }}</span> products</span>
                    <span>{{ summary.subtotal }} ‚Ç¨</span>
                </div>
                <div class="summary-row">
                    <span>Shipping to store</span>
                    <span class="free-badge">Free!</span>
                </div>
                <div class="summary-total">
                    <span>FINAL SUSTAINABILITY SCORE</span>
                    <span style="font-size: 1.3em; font-weight: bold; color: #388e3c;" id="sustainability-score">{{ sustainability_score if sustainability_score is not none else 'N/A' }}%</span>
                </div>
                {% if item_scores %}
                <div style="margin-bottom: 15px;">
                    <button class="score-toggle-btn" type="button" onclick="toggleScoreDetails()">
                        Show item scores <span id="score-chevron" class="score-chevron">‚ñº</span>
                    </button>
                    <div id="score-details" style="display:none; background:#f8f9fa; border-radius:8px; margin-top:8px; padding:10px 15px;">
                        <ul style="list-style:none; padding-left:0; margin:0;" id="score-list">
                            {% for item in item_scores %}
                            <li style="margin-bottom:6px;"><span style="font-weight:600;">{{ item.name }}</span>: <span style="color:#388e3c; font-weight:500;">{{ item.score }}%</span></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
                <div class="payment-buttons">
                    <button id="pay-btn" class="gpay-btn" style="width:100%;">
                        <span style="color: #388e3c; font-weight:600;">Pay</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class CartQRScanner {
            constructor() {
                this.qrInput = document.getElementById('cart-qr-input');
                this.statusEl = document.getElementById('scanner-status');
                this.statusIcon = document.getElementById('status-icon');
                this.statusText = document.getElementById('status-text');
                this.scannerDiv = document.getElementById('cart-scanner');
                
                this.scanTimeout = null;
                this.isProcessing = false;
                
                this.initializeScanner();
            }

            initializeScanner() {
                // Auto-focus scanner input
                this.qrInput.focus();

                // Handle input changes for scanner detection
                this.qrInput.addEventListener('input', (e) => {
                    this.handleScanInput(e.target.value);
                });

                // Handle Enter key
                this.qrInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && this.qrInput.value.trim() && !this.isProcessing) {
                        e.preventDefault();
                        this.processScan(this.qrInput.value.trim());
                    }
                });

                // Visual feedback on focus/blur
                this.qrInput.addEventListener('focus', () => {
                    this.setStatus('ready', '‚úÖ', 'Ready to scan');
                    this.qrInput.classList.add('scanning');
                    this.scannerDiv.classList.add('active');
                });

                this.qrInput.addEventListener('blur', () => {
                    this.qrInput.classList.remove('scanning');
                    this.scannerDiv.classList.remove('active');
                });
            }

            handleScanInput(value) {
                if (!value) return;

                if (this.scanTimeout) {
                    clearTimeout(this.scanTimeout);
                }

                // Detect rapid input (likely from scanner)
                const isRapidInput = value.length > 5;
                
                if (isRapidInput) {
                    this.setStatus('scanning', 'üì°', 'Scanning detected...');
                    
                    this.scanTimeout = setTimeout(() => {
                        if (value.trim()) {
                            this.processScan(value.trim());
                        }
                    }, 300);
                }
            }

            async processScan(qrCode) {
                if (this.isProcessing) return;
                
                console.log('Processing QR code in cart:', qrCode);
                this.isProcessing = true;
                this.setStatus('scanning', '‚è≥', `Processing: ${qrCode}`);

                try {
                    const response = await fetch('/add_to_cart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ qr_code: qrCode })
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.setStatus('success', '‚úÖ', `Added: ${data.item_name}`);
                        this.showSuccessToast(`üõí ${data.item_name} added to cart!`);
                        
                        // Refresh cart display
                        await this.refreshCartDisplay();
                        
                        // Clear input and prepare for next scan
                        setTimeout(() => {
                            this.qrInput.value = '';
                            this.qrInput.focus();
                            this.setStatus('ready', '‚úÖ', 'Ready for next scan');
                        }, 2000);
                    } else {
                        this.setStatus('error', '‚ùå', `Error: ${data.message}`);
                        setTimeout(() => {
                            this.setStatus('ready', '‚úÖ', 'Ready to scan');
                            this.qrInput.focus();
                        }, 3000);
                    }
                } catch (error) {
                    console.error('Cart scan error:', error);
                    this.setStatus('error', '‚ùå', 'Connection error');
                    setTimeout(() => {
                        this.setStatus('ready', '‚úÖ', 'Ready to scan');
                        this.qrInput.focus();
                    }, 3000);
                }

                this.isProcessing = false;
            }

            async refreshCartDisplay() {
                try {
                    // Reload the page to get updated cart
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (error) {
                    console.error('Error refreshing cart:', error);
                }
            }

            setStatus(type, icon, text) {
                this.statusEl.className = `scanner-status status-${type}`;
                this.statusIcon.textContent = icon;
                this.statusText.textContent = text;
            }

            showSuccessToast(message) {
                const toast = document.createElement('div');
                toast.className = 'success-toast';
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }
        
        // Initialize cart scanner and load dual scores
        let cartScanner;
        document.addEventListener('DOMContentLoaded', () => {
            cartScanner = new CartQRScanner();
            loadDualScores(); // Load the dual sustainability scores
        });

        // Helper function to get grade colors (same as before)
        function getGradeColor(grade) {
            const gradeMap = {
                'A+': '#28a745', 'A': '#28a745', 'A-': '#28a745',  // Green
                'B+': '#20c997', 'B': '#20c997', 'B-': '#20c997',  // Teal
                'C+': '#ffc107', 'C': '#ffc107', 'C-': '#ffc107',  // Yellow
                'D+': '#fd7e14', 'D': '#fd7e14',                   // Orange
                'F': '#dc3545'                                     // Red
            };
            return gradeMap[grade] || '#6c757d';
        }
        

        // Scanner control functions (unchanged)
        function focusScanner() {
            cartScanner.qrInput.focus();
            cartScanner.setStatus('ready', '‚úÖ', 'Ready to scan');
        }

        function clearScanner() {
            cartScanner.qrInput.value = '';
            cartScanner.qrInput.focus();
            cartScanner.setStatus('ready', '‚úÖ', 'Input cleared - Ready to scan');
        }

        function testCartScan() {
            const testCodes = ['SHIRT001', 'SOCK001', 'JEANS001', 'TSHIRT001'];
            const randomCode = testCodes[Math.floor(Math.random() * testCodes.length)];
            cartScanner.qrInput.value = randomCode;
            cartScanner.processScan(randomCode);
        }

        async function manualAddToCart() {
            const qrCode = cartScanner.qrInput.value.trim();
            if (qrCode) {
                await cartScanner.processScan(qrCode);
            } else {
                cartScanner.setStatus('error', '‚ùå', 'Please enter a QR code');
                setTimeout(() => {
                    cartScanner.setStatus('ready', '‚úÖ', 'Ready to scan');
                }, 2000);
            }
        }

        // Keep existing cart functions unchanged
        async function deleteItem(itemName) {
            try {
                const response = await fetch('/remove_from_cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ item_name: itemName })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const itemElement = document.querySelector(`[data-item-name="${itemName}"]`);
                    
                    if (itemElement) {
                        itemElement.style.transition = 'all 0.3s ease';
                        itemElement.style.opacity = '0';
                        itemElement.style.transform = 'translateX(-100%)';
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 300);
                    } else {
                        window.location.reload();
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Error removing item: ' + error.message);
            }
        }

        function toggleScoreDetails() {
            var details = document.getElementById('score-details');
            var chevron = document.getElementById('score-chevron');
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
                chevron.classList.add('open');
            } else {
                details.style.display = 'none';
                chevron.classList.remove('open');
            }
        }

        // Update payment button to use dual scoring data
        document.getElementById('pay-btn').addEventListener('click', async function() {
            const cartItems = {{ cart_items|tojson }};
            
            if (!cartItems.length) {
                alert('Your cart is empty!');
                return;
            }

            // Try to get dual scoring data for receipt
            try {
                const dualResponse = await fetch('/api/dual_cart_summary');
                const dualData = await dualResponse.json();
                
                if (!dualData.error) {
                    // Use dual scoring data for receipt
                    await fetch('/save_current_choice_for_receipt', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            type: 'dual_scoring',
                            initial_cost: dualData.cart_initial_cost,
                            lasting_cost: dualData.cart_lasting_cost,
                            items: dualData.item_scores,
                            insights: dualData.cart_insights
                        })
                    });
                    
                    window.location.href = '/receipt';
                    return;
                }
            } catch (error) {
                console.error('Dual scoring failed for receipt, falling back to basic analysis');
            }

            // Fallback to basic analysis for receipt
            let total = {water: 0, carbon: 0, energy: 0};
            let itemImpacts = [];
            for (const item of cartItems) {
                try {
                    let res = await fetch(`/api/analyze/${item.qr_code}`);
                    if (!res.ok) continue;
                    let data = await res.json();
                    
                    const water_impact = data.impacts.water_usage;
                    const carbon_impact = data.impacts.carbon_footprint;
                    const energy_impact = data.impacts.energy_usage;

                    let w = water_impact ? water_impact.value.toFixed(2) : '-';
                    let c = carbon_impact ? carbon_impact.value.toFixed(2) : '-';
                    let e = energy_impact ? energy_impact.value.toFixed(2) : '-';

                    if (water_impact) total.water += water_impact.value;
                    if (carbon_impact) total.carbon += carbon_impact.value;
                    if (energy_impact) total.energy += energy_impact.value;
                    
                    itemImpacts.push({name: data.item.item_name, water: w, carbon: c, energy: e});
                } catch (error) {
                    console.error("Error analyzing item for receipt:", item.qr_code, error);
                }
            }

            await fetch('/save_current_choice_for_receipt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type: 'basic_analysis',
                    items: itemImpacts,
                    total: total
                })
            });

            window.location.href = '/receipt';
        });

        // Auto-focus scanner when window regains focus
        window.addEventListener('focus', () => {
            if (cartScanner && cartScanner.qrInput) {
                cartScanner.qrInput.focus();
            }
        });


        
        
        // Load dual sustainability scores
        async function loadDualScores() {
            try {
                console.log('Loading dual sustainability scores...');
                const response = await fetch('/api/dual_cart_summary');
                
                if (!response.ok) {
                    console.log(`Dual scoring endpoint failed with status ${response.status}`);
                    if (response.status === 400) {
                        console.log('Cart is empty, skipping dual scoring');
                        return;
                    }
                    throw new Error(`Dual scoring endpoint error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    console.log('Dual scoring returned error:', data.error);
                    throw new Error(`Dual scoring error: ${data.error}`);
                }

                console.log('Dual sustainability data:', data);

                // Update main sustainability score section with dual scores
                updateDualScoreDisplay(data);
                
                // Update individual item scores
                updateItemScoresDisplay(data.item_scores);
                
                // Add cart insights
                if (data.cart_insights?.length > 0) {
                    addCartInsights(data.cart_insights);
                }
                
            } catch (error) {
                console.error('Error loading dual scores:', error);
                // Fallback to original scoring
                console.log('Falling back to original scoring...');
                loadEnhancedScores();
            }
        }

        function updateDualScoreDisplay(data) {
            const scoreElement = document.getElementById('sustainability-score');
            if (!scoreElement) return;

            const initialCost = data.cart_initial_cost;
            const lastingCost = data.cart_lasting_cost;
            
            const initialColor = getGradeColor(initialCost.grade);
            const lastingColor = getGradeColor(lastingCost.grade);
            
            scoreElement.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- Initial Cost -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 8px; border-left: 4px solid ${initialColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.8em; color: #666; font-weight: 500;">üè≠ Initial Cost</div>
                                <div style="font-size: 0.7em; color: #888;">Production impact</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 1.1em; font-weight: bold; color: #333;">
                                    ${initialCost.score}%
                                </span>
                                <span style="background: ${initialColor}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; font-weight: bold;">
                                    ${initialCost.grade}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lasting Cost -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 8px; border-left: 4px solid ${lastingColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.8em; color: #666; font-weight: 500;">üå± Lasting Cost</div>
                                <div style="font-size: 0.7em; color: #888;">Lifetime impact</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 1.1em; font-weight: bold; color: #333;">
                                    ${lastingCost.score}%
                                </span>
                                <span style="background: ${lastingColor}; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; font-weight: bold;">
                                    ${lastingCost.grade}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Overall Assessment -->
                    <div style="text-align: center; margin-top: 4px;">
                        <div style="font-size: 0.7em; color: #666;">
                            ${getDualScoreMessage(initialCost.score, lastingCost.score)}
                        </div>
                    </div>


                    <!-- Final Average Score -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 8px; border-left: 4px solid #28a745; margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.8em; color: #666; font-weight: 500;">üåç Final Score</div>
                                <div style="font-size: 0.7em; color: #888;">Average of both</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 1.1em; font-weight: bold; color: #333;">
                                    ${Math.round((data.cart_initial_cost.score + data.cart_lasting_cost.score) / 2)}%
                                </span>
                                <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.7em; font-weight: bold;">
                                    ${data.cart_initial_cost.score + data.cart_lasting_cost.score >= 140 ? 'A' : data.cart_initial_cost.score + data.cart_lasting_cost.score >= 120 ? 'B' : 'C'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateItemScoresDisplay(itemScores) {
            const scoreList = document.getElementById('score-list');
            if (!scoreList || !itemScores) return;
            
            let scoreHtml = '';
            itemScores.forEach(item => {
                const initialColor = getGradeColor(item.initial_cost.grade);
                const lastingColor = getGradeColor(item.lasting_cost.grade);
                const insight = item.sustainability_insight;
                
                scoreHtml += `
                    <li style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <!-- Item Name -->
                        <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #333;">
                            ${item.item_name}
                        </div>
                        
                        <!-- Dual Scores -->
                        <div style="display: flex; gap: 8px; margin-bottom: 6px;">
                            <div style="flex: 1; background: white; border-radius: 6px; padding: 6px; border-left: 3px solid ${initialColor};">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">üè≠ Initial</div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="font-size: 12px; font-weight: 500;">${item.initial_cost.score}%</span>
                                    <span style="background: ${initialColor}; color: white; padding: 1px 4px; border-radius: 6px; font-size: 8px; font-weight: bold;">
                                        ${item.initial_cost.grade}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="flex: 1; background: white; border-radius: 6px; padding: 6px; border-left: 3px solid ${lastingColor};">
                                <div style="font-size: 10px; color: #666; margin-bottom: 2px;">üå± Lasting</div>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <span style="font-size: 12px; font-weight: 500;">${item.lasting_cost.score}%</span>
                                    <span style="background: ${lastingColor}; color: white; padding: 1px 4px; border-radius: 6px; font-size: 8px; font-weight: bold;">
                                        ${item.lasting_cost.grade}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sustainability Insight -->
                        <div style="font-size: 10px; color: #666; font-style: italic; line-height: 1.3;">
                            <strong>${insight.recommendation}</strong><br>
                            ${insight.explanation}
                        </div>
                    </li>
                `;
            });
            scoreList.innerHTML = scoreHtml;
        }

        function addCartInsights(insights) {
            // Remove existing insights
            const existingInsights = document.getElementById('cart-insights');
            if (existingInsights) {
                existingInsights.remove();
            }
            
            // Create new insights section
            const insightsDiv = document.createElement('div');
            insightsDiv.id = 'cart-insights';
            insightsDiv.style.cssText = `
                background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
                border: 1px solid #c3e6cb;
                border-radius: 8px;
                padding: 12px;
                margin: 10px 0;
                font-size: 12px;
            `;
            
            let insightsHtml = '<div style="font-weight: 600; color: #155724; margin-bottom: 8px;">üí° Cart Insights:</div>';
            insights.forEach(insight => {
                insightsHtml += `<div style="margin-bottom: 4px; color: #155724;">${insight}</div>`;
            });
            
            insightsDiv.innerHTML = insightsHtml;
            
            // Insert after the score details
            const scoreDetails = document.getElementById('score-details');
            if (scoreDetails && scoreDetails.parentNode) {
                scoreDetails.parentNode.insertBefore(insightsDiv, scoreDetails.nextSibling);
            }
        }

        function getDualScoreMessage(initialScore, lastingScore) {
            if (initialScore >= 70 && lastingScore >= 70) {
                return "üåü Excellent in both production and lifetime impact!";
            } else if (initialScore < 40 && lastingScore >= 70) {
                return "üîÑ High initial cost, but great long-term value";
            } else if (initialScore >= 70 && lastingScore < 40) {
                return "‚ö†Ô∏è Low production cost, but poor longevity";
            } else if (initialScore < 40 && lastingScore < 40) {
                return "üö® High impact in both production and lifetime";
            } else {
                return "‚öñÔ∏è Balanced environmental impact";
            }
        }

        // Update item analysis to use dual scoring
        async function analyzeItem(qrCode, index) {
            const panel = document.getElementById(`analysis-panel-${index}`);
            const button = event.target;
            
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                button.textContent = 'Analyze Item';
                return;
            }
            
            panel.style.display = 'block';
            panel.innerHTML = 'Analyzing item with dual sustainability assessment... Please wait.';
            button.textContent = 'Analyzing...';
            
            try {
                // Try dual analysis first
                let response = await fetch(`/api/dual_analyze/${qrCode}`);
                let data = await response.json();
                
                if (data.error) {
                    console.log('Dual analysis failed, trying basic analysis');
                    response = await fetch(`/api/analyze/${qrCode}`);
                    data = await response.json();
                    
                    if (data.error) {
                        panel.innerHTML = `<div style="color: red;">${data.message}</div>`;
                        button.textContent = 'Analyze Item';
                        return;
                    } else {
                        displayBasicAnalysis(data, panel);
                    }
                } else {
                    displayDualAnalysis(data, panel);
                }
            } catch (error) {
                panel.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
            
            button.textContent = 'Hide Analysis';
        }

        // Display dual analysis results
        function displayDualAnalysis(data, panel) {
            const initial = data.initial_cost;
            const lasting = data.lasting_cost;
            const insight = data.sustainability_insight;
            
            let html = `
<div style="font-family: monospace; font-size: 12px; line-height: 1.4; white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
‚öñÔ∏è DUAL SUSTAINABILITY ANALYSIS: ${data.item_name}
${'='.repeat(65)}

üè≠ INITIAL COST (Production Impact): ${initial.score}% (${initial.grade})
   ${initial.breakdown.explanation}
   
   üìä Production Breakdown:`;

            for (const [category, score] of Object.entries(initial.breakdown.category_scores)) {
                const categoryName = category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `\n   ‚Ä¢ ${categoryName}: ${score}%`;
            }

            html += `\n\nüå± LASTING COST (Lifecycle Impact): ${lasting.score}% (${lasting.grade})
   ${lasting.breakdown.explanation}
   
   üîÑ Lifecycle Breakdown:`;

            for (const [component, score] of Object.entries(lasting.breakdown.component_scores)) {
                const componentName = component.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `\n   ‚Ä¢ ${componentName}: ${score}%`;
            }

            html += `\n\n${insight.recommendation}
${'='.repeat(65)}

üí≠ SUSTAINABILITY INSIGHT:
${insight.explanation}`;

            if (insight.material_insights?.length > 0) {
                html += `\n\nüßµ MATERIAL INSIGHTS:`;
                insight.material_insights.forEach(matInsight => {
                    html += `\n‚Ä¢ ${matInsight}`;
                });
            }

            html += `\n\nüìè ITEM DETAILS:
Weight: ${data.weight_grams}g
Materials: ${data.materials_count} different materials`;

            if (data.composition_penalty > 0) {
                html += `\nComposition penalty: -${data.composition_penalty}% (doesn't add up to 100%)`;
            }

            html += `\n\nüí° HOW TO READ THESE SCORES:
‚Ä¢ Initial Cost = Environmental damage to MAKE this item
‚Ä¢ Lasting Cost = Environmental impact THROUGHOUT its life
‚Ä¢ Both scores: 0-100% (higher = better for environment)

${insight.score_comparison.initial_higher ? 
    'This item has higher production impact but better longevity.' :
    'This item has lower production impact but worse longevity.'}
${'='.repeat(65)}
</div>`;

            panel.innerHTML = html;
        }

        // Keep the existing basic analysis function as fallback
        function displayBasicAnalysis(data, panel) {
            // Your existing displayCartAnalysis function code here
            let html = `
ITEM ANALYSIS: ${data.item.item_name}
${'='.repeat(50)}

ITEM DETAILS:
QR Code: ${data.item.qr_code}
Name: ${data.item.item_name}
Brand: ${data.item.brand || 'N/A'}
Category: ${data.item.category || 'N/A'}
Weight: ${data.item.weight_grams}g

MATERIAL COMPOSITION:`;

            data.materials.forEach(material => {
                html += `\n‚Ä¢ ${material.material_name.charAt(0).toUpperCase() + material.material_name.slice(1)}: ${material.percentage}%`;
            });

            html += `\n\nENVIRONMENTAL IMPACT ANALYSIS:\n${'-'.repeat(50)}`;

            const categoryOrder = ['water_usage', 'carbon_footprint', 'energy_usage'];
            
            categoryOrder.forEach(category => {
                if (data.impacts[category]) {
                    const impact = data.impacts[category];
                    html += `\n\n${impact.name.split(' ').slice(1).join(' ')}:`;
                    
                    impact.materials.forEach(mat => {
                        html += `\n  ${mat.material}: ${mat.impact.toFixed(2)} ${impact.unit} for this ${data.item.weight_grams}g item`;
                    });
                    
                    html += `\n  TOTAL: ${impact.value.toFixed(2)} ${impact.unit}`;
                }
            });

            panel.innerHTML = html;
        }

    </script>

    <button onclick="sendToESP32()" class="scanner-btn scanner-btn-primary" style="margin: 10px 0;">
        üì° Send to ESP32
    </button>

    <script>
    async function sendToESP32() {
        try {
            const response = await fetch('/api/send_to_esp32', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ Data sent to ESP32 successfully!');
            } else {
                alert('‚ùå Failed to send data: ' + result.message);
            }
        } catch (error) {
            alert('‚ùå Error: ' + error.message);
        }
    }
    </script>    
</body>
</html>